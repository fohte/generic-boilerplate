#!/usr/bin/env bash
#
# Apply Renovate changes from generated/ to template/
#
# Usage:
#   scripts/apply-renovate-patch [base_ref]
#
# Arguments:
#   base_ref: The base branch/ref to compare against (default: origin/master)
#
# Exit codes:
#   0: Success (versions synced or no changes)
#   1: Some files could not be synced

set -euo pipefail

BASE_REF="${1:-origin/master}"

# Sync versions from generated file to template.
# For each line with a version in the generated file, update the corresponding
# line in the template to use the same version.
sync_versions_to_template() {
  local generated_file="$1"
  local template_file="$2"
  local changes_applied=0

  while IFS= read -r line; do
    # Match version patterns: "key" = "version" (TOML) or "key": "version" (JSON)
    if [[ "$line" =~ ^[[:space:]]*(\"[^\"]+\"|[^[:space:]=:]+)[[:space:]]*[=:][[:space:]]*\"([0-9]+\.[0-9]+[^\"]*)\" ]]; then
      local key="${BASH_REMATCH[1]}"
      local version="${BASH_REMATCH[2]}"

      # Check if template has this key with a different version
      if grep -q "$key" "$template_file" 2> /dev/null; then
        # Replace version for this key in template
        if sed -i.bak "s|\\(${key}[^0-9]*\\)[0-9][0-9.]*|\\1${version}|" "$template_file"; then
          rm -f "${template_file}.bak"
          ((changes_applied++)) || true
        fi
      fi
    fi
  done < "$generated_file"

  if [[ $changes_applied -gt 0 ]]; then
    echo "    Synced $changes_applied version(s)"
    return 0
  fi
  return 1
}

# Get changed files in generated/ (Renovate's changes)
changed=$(git diff --name-only "${BASE_REF}" HEAD -- 'generated/' | grep -v '.copier-answers.yml' || true)

if [[ -z "$changed" ]]; then
  echo "No files changed in generated/"
  exit 0
fi

echo "Changed files in generated/:"
echo "$changed"
echo ""

applied_files=()
failed_files=()

while IFS= read -r generated_file; do
  # Extract relative path (e.g., generated/base/package.json -> package.json)
  rel_path=${generated_file#*/*/}

  # Find corresponding template file
  template_file=""
  if [[ -f "template/${rel_path}.jinja" ]]; then
    template_file="template/${rel_path}.jinja"
  elif [[ -f "template/${rel_path}" ]] && [[ ! -L "template/${rel_path}" ]]; then
    template_file="template/${rel_path}"
  elif [[ -L "template/${rel_path}" ]]; then
    template_file=$(realpath -m --relative-to=. "template/${rel_path}")
  fi

  if [[ -z "$template_file" ]]; then
    echo "Warning: No template file found for $generated_file"
    continue
  fi

  echo "Processing: $generated_file -> $template_file"

  if sync_versions_to_template "$generated_file" "$template_file"; then
    applied_files+=("$template_file")
  else
    failed_files+=("$generated_file -> $template_file")
  fi
done <<< "$changed"

echo ""

# Report results
if [[ ${#applied_files[@]} -gt 0 ]]; then
  echo "Successfully synced files:"
  for f in "${applied_files[@]}"; do
    echo "  - $f"
  done
fi

if [[ ${#failed_files[@]} -gt 0 ]]; then
  echo ""
  echo "Files requiring manual update:"
  for f in "${failed_files[@]}"; do
    echo "  - $f"
  done
  exit 1
fi

echo ""
echo "Done."
