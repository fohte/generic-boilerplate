#!/usr/bin/env bash
#
# Generate template snapshots from fixture data files.
#
# Usage:
#   scripts/generate-snapshots                                  # Regenerate all fixtures into generated/
#   scripts/generate-snapshots --fixture <name> --output <dir>  # Generate a single fixture to a custom directory
#
# In bulk mode (no arguments), each generated/<fixture> directory is rebuilt
# from a clean temporary copy and synced via rsync. Files listed in copier.yml
# _skip_if_exists (e.g. README.md) are preserved using rsync --exclude, and
# files no longer produced by the template are removed via --delete. For new
# fixtures, excluded files are copied from the temp dir if missing.
# In single-fixture mode, the output directory is used as-is (the caller is
# responsible for cleanup).

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Use copier directly if available, otherwise fall back to pipx run
if command -v copier > /dev/null 2>&1; then
  COPIER_CMD="copier"
else
  COPIER_CMD="pipx run copier"
fi

# Read _skip_if_exists patterns from copier.yml.
# This is the single source of truth for files to preserve during regeneration.
read_skip_if_exists() {
  yq '._skip_if_exists[]' "$REPO_ROOT/copier.yml"
}

# Convert _skip_if_exists patterns to rsync --exclude args.
build_rsync_excludes() {
  local -a excludes=()
  while IFS= read -r pattern; do
    excludes+=(--exclude "$pattern")
  done < <(read_skip_if_exists)
  printf '%s\n' "${excludes[@]}"
}

# Copy _skip_if_exists files from source to destination if they don't exist
# in the destination yet. This complements rsync --exclude which prevents
# both transfer and deletion â€” without this, new fixtures would be missing
# their initial README.md.
copy_missing_skip_files() {
  local src=$1
  local dst=$2

  while IFS= read -r pattern; do
    # Use nullglob-safe expansion of the pattern against the source tree
    for src_file in "$src"/$pattern; do
      [ -f "$src_file" ] || continue
      local rel="${src_file#"$src"/}"
      local dst_file="$dst/$rel"
      if [ ! -f "$dst_file" ]; then
        mkdir -p "$(dirname "$dst_file")"
        cp "$src_file" "$dst_file"
      fi
    done
  done < <(read_skip_if_exists)
}

# Generate a single fixture snapshot.
# All paths are relative to the current working directory.
# Arguments:
#   $1 - fixture name (corresponds to tests/fixtures/<name>.yml)
#   $2 - output directory
generate_fixture() {
  local fixture=$1
  local output_dir=$2

  $COPIER_CMD copy --trust --overwrite --data-file "tests/fixtures/$fixture.yml" . "$output_dir"

  # Remove answers file as it contains a commit hash that changes on every run
  rm -f "$output_dir/.copier-answers.yml"
}

# Parse arguments
fixture=""
output_dir=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --fixture)
      if [[ -z "${2-}" ]]; then
        echo "Error: missing argument for $1" >&2
        exit 1
      fi
      fixture=$2
      shift 2
      ;;
    --output)
      if [[ -z "${2-}" ]]; then
        echo "Error: missing argument for $1" >&2
        exit 1
      fi
      output_dir=$2
      shift 2
      ;;
    *)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
  esac
done

if [[ -n "$fixture" && -n "$output_dir" ]]; then
  # Single fixture mode
  generate_fixture "$fixture" "$output_dir"
elif [[ -z "$fixture" && -z "$output_dir" ]]; then
  # Bulk mode: regenerate all fixtures
  mapfile -t rsync_excludes < <(build_rsync_excludes)

  shopt -s nullglob
  for data_file in tests/fixtures/*.yml; do
    fixture=$(basename "$data_file" .yml)
    echo "Generating: $fixture"

    # Generate into a clean temporary directory, then sync to the real
    # output. rsync --delete removes stale files while --exclude preserves
    # files matching _skip_if_exists (README.md, etc.).
    tmpdir=$(mktemp -d)
    generate_fixture "$fixture" "$tmpdir"
    mkdir -p "generated/$fixture"
    rsync -a --delete "${rsync_excludes[@]}" "$tmpdir/" "generated/$fixture/"
    copy_missing_skip_files "$tmpdir" "generated/$fixture"
    rm -rf "$tmpdir"
  done
else
  echo "Error: --fixture and --output must be specified together" >&2
  exit 1
fi
