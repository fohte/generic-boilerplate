#!/usr/bin/env bash
#
# Generate template snapshots from fixture data files.
#
# Usage:
#   scripts/generate-snapshots                                  # Regenerate all fixtures into generated/
#   scripts/generate-snapshots --fixture <name> --output <dir>  # Generate a single fixture to a custom directory
#
# In bulk mode (no arguments), each generated/<fixture> directory is removed and
# recreated from scratch. In single-fixture mode, the output directory is used
# as-is (the caller is responsible for cleanup).

set -euo pipefail

# Use copier directly if available, otherwise fall back to pipx run
if command -v copier > /dev/null 2>&1; then
  COPIER_CMD="copier"
else
  COPIER_CMD="pipx run copier"
fi

# Generate a single fixture snapshot.
# All paths are relative to the current working directory.
# Arguments:
#   $1 - fixture name (corresponds to tests/fixtures/<name>.yml)
#   $2 - output directory
generate_fixture() {
  local fixture=$1
  local output_dir=$2

  $COPIER_CMD copy --trust --data-file "tests/fixtures/$fixture.yml" . "$output_dir"

  # Remove answers file as it contains a commit hash that changes on every run
  rm -f "$output_dir/.copier-answers.yml"
}

# Parse arguments
fixture=""
output_dir=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --fixture)
      fixture=$2
      shift 2
      ;;
    --output)
      output_dir=$2
      shift 2
      ;;
    *)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
  esac
done

if [[ -n "$fixture" && -n "$output_dir" ]]; then
  # Single fixture mode
  generate_fixture "$fixture" "$output_dir"
elif [[ -z "$fixture" && -z "$output_dir" ]]; then
  # Bulk mode: regenerate all fixtures
  for data_file in tests/fixtures/*.yml; do
    fixture=$(basename "$data_file" .yml)
    echo "Generating: $fixture"
    rm -rf "generated/$fixture"
    generate_fixture "$fixture" "generated/$fixture"
  done
else
  echo "Error: --fixture and --output must be specified together" >&2
  exit 1
fi
