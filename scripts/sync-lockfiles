#!/usr/bin/env bash
#
# Sync lockfiles from generated/ to template/
#
# Copies bun.lock/pnpm-lock.yaml and regenerates Cargo.lock for both root-level
# fixtures and monorepo subpackages (yield directory).
#
# Usage:
#   scripts/sync-lockfiles [--bun-lock] [--pnpm-lock] [--cargo-lock] [base_ref]
#
# Options:
#   --bun-lock:   Copy bun.lock files from generated/ to template/
#   --pnpm-lock:  Copy pnpm-lock.yaml files from generated/ to template/
#   --cargo-lock: Regenerate Cargo.lock in template/ from Cargo.toml.jinja
#   (no options = all)
#
# Arguments:
#   base_ref: The base branch/ref to detect changed files (default: origin/master)

set -euo pipefail

YIELD_DIR="template/{% yield pkg from subpackages %}{{ pkg.name }}{% endyield %}"

# Parse options
do_bun=false
do_pnpm=false
do_cargo=false
base_ref=""

for arg in "$@"; do
  case "$arg" in
    --bun-lock) do_bun=true ;;
    --pnpm-lock) do_pnpm=true ;;
    --cargo-lock) do_cargo=true ;;
    *) base_ref="$arg" ;;
  esac
done

# Default: all
if [[ "$do_bun" == "false" && "$do_pnpm" == "false" && "$do_cargo" == "false" ]]; then
  do_bun=true
  do_pnpm=true
  do_cargo=true
fi

base_ref="${base_ref:-origin/master}"

# Check if a lockfile changed in generated/
has_lockfile_changes() {
  local lockfile="$1"
  git diff --name-only "$base_ref" HEAD -- "generated/*/${lockfile}" "generated/*/*/${lockfile}" | grep -q .
}

# Check if any pnpm-lock.yaml changed
has_pnpm_lock_changes() {
  git diff --name-only "$base_ref" HEAD -- 'generated/*/pnpm-lock.yaml' 'generated/*/*/pnpm-lock.yaml' | grep -q .
}

# Check if any Cargo.toml.jinja was modified by apply-renovate-patch
has_cargo_toml_changes() {
  git status --porcelain | grep -q 'Cargo.toml.*\.jinja'
}

sync_bun_lock() {
  if ! has_lockfile_changes bun.lock; then
    echo "No bun.lock changes detected"
    return 0
  fi

  echo "Syncing bun.lock files..."

  # Root-level: generated/node/bun.lock -> template/bun.lock
  if [[ -f generated/node/bun.lock ]]; then
    echo "  Copying generated/node/bun.lock -> template/bun.lock"
    cp generated/node/bun.lock template/bun.lock
  fi

  # Monorepo subpackages: find node subpackages from fixture YAML and copy
  for fixture_file in tests/fixtures/*.yml; do
    local fixture
    fixture=$(basename "$fixture_file" .yml)
    local pkg_mgr
    pkg_mgr=$(yq '.node_package_manager // "bun"' "$fixture_file" 2> /dev/null || true)
    if [[ "$pkg_mgr" != "bun" ]]; then
      continue
    fi
    local subpkgs
    subpkgs=$(yq '.subpackages[]? | select(.type == "node") | .name' "$fixture_file" 2> /dev/null || true)
    for subpkg in $subpkgs; do
      local src="generated/${fixture}/${subpkg}/bun.lock"
      local dest="${YIELD_DIR}/{% if pkg.type == 'node' and node_package_manager == 'bun' %}bun.lock{% endif %}"
      if [[ -f "$src" && -f "$dest" ]]; then
        echo "  Copying $src -> yield directory"
        cp "$src" "$dest"
      fi
    done
  done
}

sync_pnpm_lock() {
  if ! has_pnpm_lock_changes; then
    echo "No pnpm-lock.yaml changes detected"
    return 0
  fi

  echo "Syncing pnpm-lock.yaml files..."

  # Root-level: generated/node-pnpm/pnpm-lock.yaml -> template/pnpm-lock.yaml
  if [[ -f generated/node-pnpm/pnpm-lock.yaml ]]; then
    echo "  Copying generated/node-pnpm/pnpm-lock.yaml -> template/pnpm-lock.yaml"
    cp generated/node-pnpm/pnpm-lock.yaml template/pnpm-lock.yaml
  fi

  # Monorepo subpackages: find node subpackages from fixture YAML and copy
  for fixture_file in tests/fixtures/*.yml; do
    local fixture
    fixture=$(basename "$fixture_file" .yml)
    local pkg_mgr
    pkg_mgr=$(yq '.node_package_manager // ""' "$fixture_file" 2> /dev/null || true)
    if [[ "$pkg_mgr" != "pnpm" ]]; then
      continue
    fi
    local subpkgs
    subpkgs=$(yq '.subpackages[]? | select(.type == "node") | .name' "$fixture_file" 2> /dev/null || true)
    for subpkg in $subpkgs; do
      local src="generated/${fixture}/${subpkg}/pnpm-lock.yaml"
      local dest="${YIELD_DIR}/{% if pkg.type == 'node' and node_package_manager == 'pnpm' %}pnpm-lock.yaml{% endif %}"
      if [[ -f "$src" && -f "$dest" ]]; then
        echo "  Copying $src -> yield directory"
        cp "$src" "$dest"
      fi
    done
  done
}

sync_cargo_lock() {
  if ! has_cargo_toml_changes && ! has_lockfile_changes Cargo.lock; then
    echo "No Cargo.toml.jinja or Cargo.lock changes detected"
    return 0
  fi

  echo "Regenerating Cargo.lock files..."

  # Root-level: template/Cargo.toml.jinja -> template/Cargo.lock
  if [[ -f template/Cargo.toml.jinja ]]; then
    echo "  Regenerating template/Cargo.lock"
    local project_name
    project_name=$(yq '.project_name' tests/fixtures/rust.yml)
    sed "s/{{ project_name }}/${project_name}/g" template/Cargo.toml.jinja > template/Cargo.toml
    (cd template && cargo generate-lockfile)
    rm template/Cargo.toml
  fi

  # Monorepo subpackages: find rust subpackages and regenerate their Cargo.lock
  local yield_cargo="${YIELD_DIR}/{% if pkg.type == 'rust' %}Cargo.toml{% endif %}.jinja"
  if [[ -f "$yield_cargo" ]]; then
    for fixture_file in tests/fixtures/*.yml; do
      local fixture
      fixture=$(basename "$fixture_file" .yml)
      local subpkgs
      subpkgs=$(yq '.subpackages[]? | select(.type == "rust") | .name' "$fixture_file" 2> /dev/null || true)
      for subpkg in $subpkgs; do
        if [[ -d "generated/${fixture}/${subpkg}" ]]; then
          local yield_lock="${YIELD_DIR}/{% if pkg.type == 'rust' %}Cargo.lock{% endif %}"
          echo "  Regenerating yield directory Cargo.lock (from ${fixture}/${subpkg})"
          sed "s/{{ pkg.name }}/${subpkg}/g" "$yield_cargo" > "${YIELD_DIR}/Cargo.toml"
          (cd "$YIELD_DIR" && cargo generate-lockfile)
          mv "${YIELD_DIR}/Cargo.lock" "$yield_lock"
          rm "${YIELD_DIR}/Cargo.toml"
          # Only need one rust subpackage to regenerate the template lockfile
          return 0
        fi
      done
    done
  fi
}

if [[ "$do_bun" == "true" ]]; then
  sync_bun_lock
fi

if [[ "$do_pnpm" == "true" ]]; then
  sync_pnpm_lock
fi

if [[ "$do_cargo" == "true" ]]; then
  sync_cargo_lock
fi
