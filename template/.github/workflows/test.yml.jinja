{#- Helper variables for monorepo mode -#}
{%- set has_node = (type == 'node') or (subpackages | selectattr('type', 'equalto', 'node') | list | length > 0) -%}
{%- set has_rust = (type == 'rust') or (subpackages | selectattr('type', 'equalto', 'rust') | list | length > 0) -%}
{%- set node_pkgs = subpackages | selectattr('type', 'equalto', 'node') | list -%}
{%- set rust_pkgs = subpackages | selectattr('type', 'equalto', 'rust') | list -%}
name: Test

on:
  push:
{%- if use_release_please %}
    branches-ignore:
      # Skip release-please branches (Release PRs) since they only update CHANGELOG and version
      - release-please--branches--*
{%- endif %}

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: {% raw %}${{ secrets.APP_ID }}{% endraw %}
          private-key: {% raw %}${{ secrets.APP_PRIVATE_KEY }}{% endraw %}

      - uses: actions/checkout@v6
        with:
          persist-credentials: false
          fetch-depth: 2

      - name: Check if previous commit is auto-format by bot
        id: check-prev
        run: |
          prev_commit_message=$(git log -1 --skip=1 --format=%s)
          prev_commit_author=$(git log -1 --skip=1 --format=%an)
          echo "Previous commit message: $prev_commit_message"
          echo "Previous commit author: $prev_commit_author"

          # Skip auto-format commit if previous commit is auto-format by a bot
          if [ "$prev_commit_message" = "style: auto-format" ] && [[ "$prev_commit_author" == *"[bot]"* ]]; then
            echo "skip_commit=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip_commit=false" >> "$GITHUB_OUTPUT"
          fi

{%- if has_rust %}

      # Run rustup before mise-action to prevent race condition.
      # Multiple cargo: tools in mise.toml trigger parallel rustup component downloads,
      # causing "could not rename downloaded file" errors.
      - run: rustup show
{%- endif %}

      - uses: jdx/mise-action@v3
{%- if type == 'node' %}
{%- if node_package_manager == 'pnpm' %}

      - name: Cache pnpm store
        uses: actions/cache@v5
        with:
          path: |
            ~/.local/share/pnpm/store/v3
            node_modules
          key: {% raw %}${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}{% endraw %}
          restore-keys: {% raw %}${{ runner.os }}-pnpm-{% endraw %}

      - run: pnpm install --frozen-lockfile
{%- else %}

      - name: Cache bun dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.bun/install/cache
            ~/.bun/install/global
            node_modules
          key: {% raw %}${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}{% endraw %}
          restore-keys: {% raw %}${{ runner.os }}-bun-{% endraw %}

      - run: bun install --frozen-lockfile
{%- endif %}
{%- elif type == 'rust' %}

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2

      - run: cargo fetch
{%- elif subpackages %}
{%- if has_node %}
{%- if node_package_manager == 'pnpm' %}

      - name: Cache pnpm store
        uses: actions/cache@v5
        with:
          path: |
            ~/.local/share/pnpm/store/v3
{%- for pkg in node_pkgs %}
            {{ pkg.name }}/node_modules
{%- endfor %}
          key: {% raw %}${{ runner.os }}-pnpm-${{ hashFiles({% endraw %}{% for pkg in node_pkgs %}'{{ pkg.name }}/pnpm-lock.yaml'{{ ', ' if not loop.last else '' }}{% endfor %}{% raw %}) }}{% endraw %}
          restore-keys: {% raw %}${{ runner.os }}-pnpm-{% endraw %}

{%- for pkg in node_pkgs %}

      - name: Install pnpm dependencies ({{ pkg.name }})
        run: cd "$PKG_NAME" && pnpm install --frozen-lockfile
        env:
          PKG_NAME: {{ pkg.name }}
{%- endfor %}
{%- else %}

      - name: Cache bun dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.bun/install/cache
            ~/.bun/install/global
{%- for pkg in node_pkgs %}
            {{ pkg.name }}/node_modules
{%- endfor %}
          key: {% raw %}${{ runner.os }}-bun-${{ hashFiles({% endraw %}{% for pkg in node_pkgs %}'{{ pkg.name }}/bun.lock'{{ ', ' if not loop.last else '' }}{% endfor %}{% raw %}) }}{% endraw %}
          restore-keys: {% raw %}${{ runner.os }}-bun-{% endraw %}

{%- for pkg in node_pkgs %}

      - name: Install bun dependencies ({{ pkg.name }})
        run: cd "$PKG_NAME" && bun install --frozen-lockfile
        env:
          PKG_NAME: {{ pkg.name }}
{%- endfor %}
{%- endif %}
{%- endif %}
{%- if has_rust %}

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |-
{%- for pkg in rust_pkgs %}
            {{ pkg.name }}
{%- endfor %}

{%- for pkg in rust_pkgs %}

      - name: Fetch cargo dependencies ({{ pkg.name }})
        run: cd "$PKG_NAME" && cargo fetch
        env:
          PKG_NAME: {{ pkg.name }}
{%- endfor %}
{%- endif %}
{%- endif %}

      - name: Run lefthook
        id: lefthook
        continue-on-error: true
        run: lefthook run pre-commit --all-files

      # lefthook-config's formatters run `git add` after formatting, which stages the changes.
      # https://github.com/fohte/lefthook-config/blob/v0.1.7/base.yml
      # commit-action uses `git ls-files --modified` which only detects unstaged changes.
      # https://github.com/suzuki-shunsuke/commit-action/blob/87b297f0ce551411b43d1880f4fb3cbc60381055/action.yaml#L57
      # We need to unstage the changes so commit-action can detect them.
      - name: Unstage changes for commit-action
        run: git restore --staged .

      - name: Commit formatted files
        if: {% raw %}${{ !cancelled() && steps.check-prev.outputs.skip_commit != 'true' }}{% endraw %}
        uses: suzuki-shunsuke/commit-action@v0.1.0
        with:
          commit_message: 'style: auto-format'
          workflow: deny
          github_token: {% raw %}${{ steps.app-token.outputs.token }}{% endraw %}

      - name: Fail if lefthook failed
        if: steps.lefthook.outcome == 'failure'
        run: exit 1
{%- if type == 'node' %}

  unit-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: jdx/mise-action@v3
{%- if node_package_manager == 'pnpm' %}

      - name: Cache pnpm store
        uses: actions/cache@v5
        with:
          path: |
            ~/.local/share/pnpm/store/v3
            node_modules
          key: {% raw %}${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}{% endraw %}
          restore-keys: {% raw %}${{ runner.os }}-pnpm-{% endraw %}

      - run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm run test
{%- else %}

      - name: Cache bun dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.bun/install/cache
            ~/.bun/install/global
            node_modules
          key: {% raw %}${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}{% endraw %}
          restore-keys: {% raw %}${{ runner.os }}-bun-{% endraw %}

      - run: bun install --frozen-lockfile

      - name: Run tests
        run: bun run test
{%- endif %}
{%- elif type == 'rust' %}

  unit-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - run: rustup show

      - uses: jdx/mise-action@v3

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
{%- if use_coverage %}

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Install llvm-tools-preview
        run: rustup component add llvm-tools-preview

      - name: Run tests with coverage
        run: cargo llvm-cov --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: {% raw %}${{ secrets.CODECOV_TOKEN }}{% endraw %}
          files: lcov.info
          fail_ci_if_error: false
{%- else %}

      - name: Run tests
        run: cargo test
{%- endif %}
{%- elif subpackages %}
{%- for pkg in subpackages if pkg.type in ['node', 'rust'] %}

  unit-test-{{ pkg.name }}:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
{%- if pkg.type == 'rust' %}

      - run: rustup show
{%- endif %}

      - uses: jdx/mise-action@v3
{%- if pkg.type == 'node' %}
{%- if node_package_manager == 'pnpm' %}

      - name: Cache pnpm store
        uses: actions/cache@v5
        with:
          path: |
            ~/.local/share/pnpm/store/v3
            {{ pkg.name }}/node_modules
          key: {% raw %}${{ runner.os }}-pnpm-${{ hashFiles({% endraw %}'{{ pkg.name }}/pnpm-lock.yaml'{% raw %}) }}{% endraw %}
          restore-keys: {% raw %}${{ runner.os }}-pnpm-{% endraw %}

      - name: Install pnpm dependencies
        run: cd "$PKG_NAME" && pnpm install --frozen-lockfile
        env:
          PKG_NAME: {{ pkg.name }}

      - name: Run tests
        working-directory: {{ pkg.name }}
        run: pnpm run test
{%- else %}

      - name: Cache bun dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.bun/install/cache
            ~/.bun/install/global
            {{ pkg.name }}/node_modules
          key: {% raw %}${{ runner.os }}-bun-${{ hashFiles({% endraw %}'{{ pkg.name }}/bun.lock'{% raw %}) }}{% endraw %}
          restore-keys: {% raw %}${{ runner.os }}-bun-{% endraw %}

      - name: Install bun dependencies
        run: cd "$PKG_NAME" && bun install --frozen-lockfile
        env:
          PKG_NAME: {{ pkg.name }}

      - name: Run tests
        working-directory: {{ pkg.name }}
        run: bun run test
{%- endif %}
{%- elif pkg.type == 'rust' %}

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: {{ pkg.name }}
{%- if use_coverage %}

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Install llvm-tools-preview
        run: rustup component add llvm-tools-preview

      - name: Run tests with coverage
        working-directory: {{ pkg.name }}
        run: cargo llvm-cov --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: {% raw %}${{ secrets.CODECOV_TOKEN }}{% endraw %}
          files: {{ pkg.name }}/lcov.info
          flags: {{ pkg.name }}
          fail_ci_if_error: false
{%- else %}

      - name: Run tests
        working-directory: {{ pkg.name }}
        run: cargo test
{%- endif %}
{%- endif %}
{%- endfor %}
{%- endif %}
